<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.RoomName}} - ChatX</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; padding: 20px; background: white; border-radius: 5px; }
        h1 { color: #333; }
        .chat-container { height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9; }
        .message { padding: 8px; border-radius: 5px; background: white; margin-bottom: 8px; position: relative; border-left: 3px solid #ddd; }
        .admin { color: #d9534f; font-weight: bold; }
        .delete-btn { background: none; border: none; cursor: pointer; color: #d9534f; float: right; }
        .message-form { display: flex; gap: 10px; }
        #messageInput { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        #sendButton { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{.RoomName}}</h1>
        <div>Logged in as: <b>{{.Username}}</b> ({{.Role}}) | <a href="/hub">‚¨Ö Back to Rooms</a></div>
        
        <!-- Chat messages container -->
        <div id="chatMessages" class="chat-container">
            {{range .Messages}}
            <div class="message" data-message-id="{{.ID}}">
                <span class="username {{.Role}}">{{.Username}}:</span>
                <span class="message-text">{{.Content}}</span>
                <span class="message-time">{{.Timestamp.Format "15:04:05"}}</span>
                {{if .Deletable}} <button class="delete-btn" onclick="deleteMessage({{.ID}})">üóëÔ∏è Delete</button> {{end}}
            </div>
            {{end}}
        </div>

        <!-- Message input form -->
        <form id="messageForm" class="message-form">
            <input type="text" id="messageInput" placeholder="Enter message..." disabled>
            <button id="sendButton">Send</button>
        </form>
    </div>

    <!-- Hidden fields for JavaScript access -->
    <input type="hidden" id="current-user-id" value="{{.UserID}}">
    <input type="hidden" id="current-user-role" value="{{.Role}}">
    <input type="hidden" id="room-id" value="{{.RoomID}}">

    <!-- Load chat.js and append past messages dynamically -->
    <script src="/static/js/chat.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const messagesRaw = `{{.MessagesJSON}}`;
            console.log("Raw messages JSON:", messagesRaw); // Log raw JSON before parsing
        
            try {
                const messagesData = JSON.parse(messagesRaw || "[]");
                console.log("Parsed messages JSON:", messagesData); // Log parsed messages
        
                const messageContainer = document.getElementById("chatMessages");
        
                messagesData.forEach(msg => {
                    const messageDiv = document.createElement("div");
                    messageDiv.className = "message";
                    messageDiv.dataset.messageId = msg.id;
        
                    // FIX: Ensure delete button follows permission rules
                    const deleteButton = msg.deletable ? `<button class="delete-btn" onclick="deleteMessage(${msg.id})">üóëÔ∏è Delete</button>` : "";
        
                    messageDiv.innerHTML = `
                        <span class="username ${msg.role}">${msg.username}:</span>
                        <span class="message-text">${msg.content}</span>
                        <span class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                        ${deleteButton} 
                    `;
                    messageContainer.appendChild(messageDiv);
                });
        
            } catch (e) {
                console.error("Error parsing messages JSON:", e);
            }
        });
        </script>
</body>
</html>